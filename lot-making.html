<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Agent Pro - Lot Making</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=PT+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="agent-profile">
                    <div class="avatar">
                        <img src="https://avatar.vercel.sh/Post%20Agent.png" alt="Post Agent" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="avatar-fallback" style="display: none;">PA</div>
                    </div>
                    <div class="agent-info">
                        <span class="agent-name">Post Agent</span>
                        <span class="agent-number">PA-12345</span>
                    </div>
                </div>
            </div>
            <nav class="sidebar-nav">
                <ul class="nav-menu">
                    <li class="nav-item"><a href="index.html" class="nav-link"><span>Dashboard</span></a></li>
                    <li class="nav-item"><a href="customers.html" class="nav-link"><span>Customers</span></a></li>
                    <li class="nav-item"><a href="new-collection.html" class="nav-link"><span>New Collection</span></a></li>
                    <li class="nav-item"><a href="collections.html" class="nav-link"><span>All Collections</span></a></li>
                    <li class="nav-item"><a href="deposits.html" class="nav-link"><span>Deposits</span></a></li>
                    <li class="nav-item active"><a href="lot-making.html" class="nav-link"><span>Lot Making</span></a></li>
                    <li class="nav-item"><a href="pre-lot-making.html" class="nav-link"><span>PreLOT Making</span></a></li>
                    <li class="nav-item"><a href="reports.html" class="nav-link"><span>Reports</span></a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <ul class="nav-menu">
                    <li class="nav-item"><a href="settings.html" class="nav-link"><span>Settings</span></a></li>
                </ul>
                <div class="copyright"><p>&copy; 2025 Post Agent Pro</p></div>
            </div>
        </aside>
        <main class="main-content">
            <header class="header">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <h1 class="page-title">Lot Making</h1>
                <div class="header-actions">
                    <button class="btn btn-outline btn-icon" onclick="logout()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16,17 21,12 16,7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        <span class="sr-only">Logout</span>
                    </button>
                </div>
            </header>
            <div class="content">
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">Build Lot (Max <span id="maxLotAmountLabel"></span>)</h3>
                    </div>
                    <div class="card-content">
                        <form id="lotForm" onsubmit="handleAddToLot(event)">
                            <div class="form-group">
                                <label class="form-label" for="lotDate">Date</label>
                                <input type="date" id="lotDate" name="date" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="lotCustomerSearch">Add Customer</label>
                                <input id="lotCustomerSearch" class="form-input" placeholder="Search by name, SC or A/C" />
                                <select id="lotCustomer" class="form-input" size="6" style="margin-top:0.5rem;"></select>
                                <div style="margin-top:0.5rem; color:hsl(var(--muted-foreground)); font-size:0.9rem;">Type to filter; press Enter or click to select.</div>
                            </div>
                            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                                <button type="button" class="btn btn-outline" onclick="resetLot()">Reset</button>
                                <button type="submit" class="btn btn-primary">Add to Lot</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Lot Preview</h3>
                    </div>
                    <div class="card-content">
                        <div style="display:flex; gap:0.75rem; margin-bottom:0.75rem; align-items:center;">
                            <input id="lotSearch" class="form-input" placeholder="Search customer or receipt" style="max-width:300px;">
                            <div id="lotTotalLabel" style="font-weight:600;"></div>
                        </div>
                        <div class="table-container">
                            <table class="table" id="lotTable">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Customer</th>
                                        <th>Installment</th>
                                        <th>Months</th>
                                        <th>Penalty</th>
                                        <th>Total</th>
                                        <th>Receipt No.</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="lotTableBody">
                                    <tr><td colspan="6" style="text-align:center; padding:1rem; color:hsl(var(--muted-foreground));">Add customers to build the lot.</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div style="display:flex; justify-content:space-between; gap:1rem; margin-top:1rem; align-items:center; flex-wrap: wrap;">
                            <div style="display:flex; gap:1rem;">
                                <button class="btn btn-outline" onclick="exportLotCSV()">Export CSV</button>
                                <button class="btn btn-outline" onclick="viewLot()">View</button>
                                <button class="btn btn-primary" onclick="printLot()">Print</button>
                            </div>
                            <div style="display:flex; gap:1rem;">
                                <button class="btn btn-outline" onclick="exportAccountNumbers()">Export Account Numbers</button>
                                <button class="btn btn-outline" onclick="viewAccountNumbers()">View Account Numbers</button>
                                <button class="btn btn-primary" onclick="printAccountNumbers()">Print Account Numbers</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="app.js"></script>
    <script>
        let currentLotRows = [];
        let currentLotTotal = 0;
        let maxLot = 20000;

        document.addEventListener('DOMContentLoaded', function(){
            // init
            document.getElementById('lotDate').value = new Date().toISOString().slice(0,10);
            maxLot = (app.appSettings && app.appSettings.maxLotAmount) || 20000;
            document.getElementById('maxLotAmountLabel').textContent = formatCurrency(maxLot);
            seedCustomerSelect();
            const search = document.getElementById('lotSearch');
            if (search){ search.addEventListener('input', filterLotTable); }
        });

        function seedCustomerSelect(){
            const select = document.getElementById('lotCustomer');
            const search = document.getElementById('lotCustomerSearch');
            const all = (app.customers||[]).slice().sort((a,b)=> (parseInt(a.shortCode||'0',10)||0) - (parseInt(b.shortCode||'0',10)||0));
            const render = () => {
                const term = (search.value||'').toLowerCase();
                const filtered = !term ? all : all.filter(c =>
                    (c.name||'').toLowerCase().includes(term) ||
                    String(c.shortCode||'').toLowerCase().includes(term) ||
                    String(c.accountNumber||'').toLowerCase().includes(term)
                );
                select.innerHTML = filtered.map(c=>`<option value="${c.id}">${c.name} (Acc: ${c.accountNumber||'-'} Â· SC: ${c.shortCode||'-'})</option>`).join('');
            };
            render();
            search.addEventListener('input', render);
            // Double click any visible option to add immediately
            select.addEventListener('dblclick', ()=> handleAddToLot(new Event('submit')));
            select.addEventListener('change', ()=>{ /* keep selection for Add button */ });
            search.addEventListener('keydown', (e)=>{ if (e.key==='Enter'){ e.preventDefault(); if (select.options.length>0){ select.selectedIndex = 0; handleAddToLot(new Event('submit')); } }});
        }

        function resetLot(){
            currentLotRows = [];
            currentLotTotal = 0;
            document.getElementById('lotTableBody').innerHTML = '<tr><td colspan="6" style="text-align:center; padding:1rem; color:hsl(var(--muted-foreground));">Add customers to build the lot.</td></tr>';
            document.getElementById('lotTotalLabel').textContent = '';
        }

        function handleAddToLot(e){
            e.preventDefault();
            const select = document.getElementById('lotCustomer');
            const customerId = document.getElementById('lotCustomer').value;
            if (!customerId){ showToast('Please select a customer','warning'); return; }
            const customer = (app.customers||[]).find(c=>c.id===customerId);
            if (!customer){ showToast('Customer not found','error'); return; }
            const date = document.getElementById('lotDate').value;

            // Collect customer's collections (all-time) to add into lot
            const rows = (app.collections||[])
                .filter(col => col.customerId === customerId)
                .map(col=>{
                    const months = Number(col.months||1);
                    const inst = (col.installmentAmount!=null) ? Number(col.installmentAmount) : (Number(col.amount||0)/months);
                    const penalty = Number(col.penalty||0);
                    const total = (inst*months) + penalty;
                    const d = new Date(col.createdAt||Date.now()).toLocaleDateString();
                    return {date: d, customerName: customer.name, accountNumber: customer.accountNumber||'', installment: inst, months, penalty, total, receiptNumber: col.receiptNumber||'N/A'};
                });
            if (rows.length===0){ showToast('No collections for selected customer','info'); return; }

            const currentBase = currentLotRows.reduce((s,rr)=> s + rr.installment*rr.months, 0);
            let addedAny = false;
            for (const r of rows){
                const prospectiveBase = currentBase + (r.installment*r.months);
                if (prospectiveBase > maxLot){
                    // stop adding more without alerting if nothing added in this operation
                    break;
                }
                currentLotRows.push(r);
                currentLotTotal += r.total;
                addedAny = true;
            }
            if (!addedAny){ return; }
            renderLotTable();
        }

        function renderLotTable(){
            const tbody = document.getElementById('lotTableBody');
            if (currentLotRows.length===0){
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:1rem; color:hsl(var(--muted-foreground));">Add customers to build the lot.</td></tr>';
            } else {
                tbody.innerHTML = currentLotRows.map((r,idx)=>`
                    <tr>
                        <td>${r.date}</td>
                        <td>${r.customerName}</td>
                        <td>${formatCurrency(r.installment)}</td>
                        <td>${r.months}</td>
                        <td>${formatCurrency(r.penalty)}</td>
                        <td>${formatCurrency(r.total)}</td>
                        <td>${r.receiptNumber}</td>
                        <td><button class="btn btn-outline btn-sm" onclick="removeLotRow(${idx})">Remove</button></td>
                    </tr>
                `).join('');
            }
            const penaltySum = currentLotRows.reduce((s,r)=> s + r.penalty, 0);
            const baseSum = currentLotRows.reduce((s,r)=> s + r.installment*r.months, 0);
            document.getElementById('lotTotalLabel').textContent = 'Total: ' + formatCurrency(baseSum + penaltySum) + '  |  Base: ' + formatCurrency(baseSum) + '  |  Penalty: ' + formatCurrency(penaltySum);
            filterLotTable();
        }

        function removeLotRow(idx){
            if (idx<0 || idx>=currentLotRows.length) return;
            currentLotTotal -= (currentLotRows[idx]?.total||0);
            currentLotRows.splice(idx,1);
            renderLotTable();
        }

        function filterLotTable(){
            const term = (document.getElementById('lotSearch')?.value||'').toLowerCase();
            const rows = document.querySelectorAll('#lotTableBody tr');
            rows.forEach(tr=>{
                const text = tr.innerText.toLowerCase();
                tr.style.display = text.includes(term) ? '' : 'none';
            });
        }

        function exportLotCSV(){
            if (!currentLotRows.length){ showToast('Nothing to export','warning'); return; }
            const headers = ['Date','Customer','Installment','Months','Penalty','Total','Receipt'];
            const rows = currentLotRows.map(r=>({Date:r.date, Customer:r.customerName, Installment:r.installment, Months:r.months, Penalty:r.penalty, Total:r.total, Receipt:r.receiptNumber}));
            const csv = toCSV(headers, rows);
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'lot.csv'; a.click();
            URL.revokeObjectURL(url);
            showToast('CSV exported', 'success');
        }

        function viewLot(){
            if (!currentLotRows.length){ showToast('Nothing to view','warning'); return; }
            const w = window.open('', '_blank');
            const html = '<h3>Lot Preview</h3>' +
                '<pre>' + currentLotRows.map(r=> `${r.date} | ${r.customerName} | ${formatCurrency(r.amount)} | ${formatCurrency(r.penalty)} | ${formatCurrency(r.total)} | ${r.receiptNumber}`).join('\n') + '</pre>' +
                `<div><strong>Total:</strong> ${formatCurrency(currentLotTotal)}</div>`;
            w.document.write(html);
            w.document.close();
        }

        function printLot(){
            viewLot();
            setTimeout(()=> window.print(), 300);
        }

        function exportAccountNumbers(){
            if (!currentLotRows.length){ showToast('Nothing to export','warning'); return; }
            const accounts = currentLotRows.map(r=> r.accountNumber).filter(Boolean);
            const unique = [...new Set(accounts)];
            const text = unique.join(',');
            const blob = new Blob([text], {type:'text/plain;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'lot-account-numbers.txt'; a.click();
            URL.revokeObjectURL(url);
            showToast('Account numbers exported', 'success');
        }

        function viewAccountNumbers(){
            if (!currentLotRows.length){ showToast('Nothing to view','warning'); return; }
            const accounts = currentLotRows.map(r=> r.accountNumber).filter(Boolean);
            const unique = [...new Set(accounts)];
            const w = window.open('', '_blank');
            const html = '<h3>Account Numbers</h3>' + '<pre>' + unique.join(',') + '</pre>';
            w.document.write(html);
            w.document.close();
        }

        function printAccountNumbers(){
            viewAccountNumbers();
            setTimeout(()=> window.print(), 300);
        }
    </script>
</body>
</html>
