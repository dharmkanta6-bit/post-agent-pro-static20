<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Post Agent Pro - Reports</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=PT+Sans:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="agent-profile">
                    <div class="avatar">
                        <img src="https://avatar.vercel.sh/Post%20Agent.png" alt="Post Agent" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="avatar-fallback" style="display: none;">PA</div>
                    </div>
                    <div class="agent-info">
                        <span class="agent-name">Post Agent</span>
                        <span class="agent-number">PA-12345</span>
                    </div>
                </div>
            </div>
            <nav class="sidebar-nav">
                <ul class="nav-menu">
                    <li class="nav-item"><a href="index.html" class="nav-link"><span>Dashboard</span></a></li>
                    <li class="nav-item"><a href="customers.html" class="nav-link"><span>Customers</span></a></li>
                    <li class="nav-item"><a href="new-collection.html" class="nav-link"><span>New Collection</span></a></li>
                    <li class="nav-item"><a href="collections.html" class="nav-link"><span>All Collections</span></a></li>
                    <li class="nav-item"><a href="deposits.html" class="nav-link"><span>Deposits</span></a></li>
                    <li class="nav-item"><a href="lot-making.html" class="nav-link"><span>Lot Making</span></a></li>
                    <li class="nav-item active"><a href="reports.html" class="nav-link"><span>Reports</span></a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <ul class="nav-menu">
                    <li class="nav-item"><a href="settings.html" class="nav-link"><span>Settings</span></a></li>
                </ul>
                <div class="copyright"><p>&copy; 2025 Post Agent Pro</p></div>
            </div>
        </aside>
        <main class="main-content">
            <header class="header">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <h1 class="page-title">Reports</h1>
                <div class="header-actions">
                    <button class="btn btn-outline btn-icon" onclick="logout()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16,17 21,12 16,7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        <span class="sr-only">Logout</span>
                    </button>
                </div>
            </header>
            <div class="content">
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header">
                        <h3 class="card-title">Filters</h3>
                    </div>
                    <div class="card-content">
                        <form id="reportFilters" onsubmit="handleRunReport(event)" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div>
                                <label class="form-label" for="reportType">Report Type</label>
                                <select id="reportType" class="form-input" required>
                                    <option value="monthly_collections">Monthly Collections</option>
                                    <option value="periodic_collections">Periodic Collections</option>
                                    <option value="deposits">Deposits</option>
                                    <option value="customer_ledger">Customer Ledger</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label" for="fromDate">From</label>
                                <input type="date" id="fromDate" class="form-input">
                            </div>
                            <div>
                                <label class="form-label" for="toDate">To</label>
                                <input type="date" id="toDate" class="form-input">
                            </div>
                            <div>
                                <label class="form-label" for="customerSelect">Customer</label>
                                <select id="customerSelect" class="form-input">
                                    <option value="">All customers</option>
                                </select>
                            </div>
                            <div style="align-self:end; display:flex; gap:0.75rem;">
                                <button type="button" class="btn btn-outline" onclick="resetFilters()">Reset</button>
                                <button type="submit" class="btn btn-primary">Run Report</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Results</h3>
                    </div>
                    <div class="card-content">
                        <div id="summary" style="margin-bottom:1rem; color:hsl(var(--muted-foreground));"></div>
                        <div class="table-container">
                            <table class="table" id="reportTable">
                                <thead id="reportHead"><tr><th>Column</th></tr></thead>
                                <tbody id="reportBody"><tr><td style="text-align:center; padding:1rem; color:hsl(var(--muted-foreground));">No data. Run a report.</td></tr></tbody>
                            </table>
                        </div>
                        <div style="display:flex; justify-content:flex-end; gap:1rem; margin-top:1rem;">
                            <button class="btn btn-outline" onclick="exportReportCSV()">Export CSV</button>
                            <button class="btn btn-primary" onclick="window.print()">Print</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function(){
            const customerSelect = document.getElementById('customerSelect');
            customerSelect.innerHTML = '<option value="">All customers</option>' + (app.customers||[]).map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
        });

        function resetFilters(){
            document.getElementById('reportFilters').reset();
            document.getElementById('reportBody').innerHTML = '<tr><td style="text-align:center; padding:1rem; color:hsl(var(--muted-foreground));">No data. Run a report.</td></tr>';
            document.getElementById('reportHead').innerHTML = '<tr><th>Column</th></tr>';
            document.getElementById('summary').textContent = '';
        }

        function handleRunReport(e){
            e.preventDefault();
            const type = document.getElementById('reportType').value;
            const from = new Date(document.getElementById('fromDate').value);
            const to = new Date(document.getElementById('toDate').value);
            const customerId = document.getElementById('customerSelect').value;

            const inRange = (d)=>{
                return (!isNaN(from) ? d >= from : true) && (!isNaN(to) ? d <= to : true);
            };

            let rows = [];
            let header = [];
            let summary = '';

            if (type === 'monthly_collections' || type === 'periodic_collections'){
                const cols = (app.collections||[]).filter(c=>{
                    const d = new Date(c.createdAt||Date.now());
                    const byCustomer = customerId ? c.customerId === customerId : true;
                    return inRange(d) && byCustomer;
                });
                header = ['Date','Customer','Amount','Penalty','Total','Receipt'];
                rows = cols.map(c=>{
                    const customer = (app.customers||[]).find(x=>x.id===c.customerId);
                    const amount = Number(c.amount||0);
                    const penalty = Number(c.penalty||0);
                    const total = amount + penalty;
                    return [new Date(c.createdAt||Date.now()).toLocaleDateString(), customer?customer.name:'Unknown', formatCurrency(amount), formatCurrency(penalty), formatCurrency(total), c.receiptNumber||'N/A'];
                });
                const totals = cols.reduce((acc,c)=>{
                    acc.amount += Number(c.amount||0); acc.penalty += Number(c.penalty||0); return acc;
                }, {amount:0,penalty:0});
                summary = `Records: ${cols.length} | Amount: ${formatCurrency(totals.amount)} | Penalty: ${formatCurrency(totals.penalty)} | Total: ${formatCurrency(totals.amount + totals.penalty)}`;
            } else if (type === 'deposits'){
                const deps = (app.deposits||[]).filter(d=> inRange(new Date(d.createdAt||Date.now())));
                header = ['Date','Amount','Bank','Reference','Notes'];
                rows = deps.map(d=> [new Date(d.createdAt||Date.now()).toLocaleDateString(), formatCurrency(Number(d.amount||0)), d.bank||'N/A', d.reference||'N/A', d.notes||'']);
                const total = deps.reduce((s,d)=> s + Number(d.amount||0), 0);
                summary = `Records: ${deps.length} | Total Deposits: ${formatCurrency(total)}`;
            } else if (type === 'customer_ledger'){
                const cols = (app.collections||[]).filter(c=> customerId ? c.customerId === customerId : false);
                header = ['Date','Amount','Penalty','Total','Receipt'];
                rows = cols.map(c=>{
                    const amount = Number(c.amount||0);
                    const penalty = Number(c.penalty||0);
                    return [new Date(c.createdAt||Date.now()).toLocaleDateString(), formatCurrency(amount), formatCurrency(penalty), formatCurrency(amount+penalty), c.receiptNumber||'N/A'];
                });
                const totals = cols.reduce((acc,c)=>{ acc.amount += Number(c.amount||0); acc.penalty += Number(c.penalty||0); return acc;}, {amount:0,penalty:0});
                const customer = (app.customers||[]).find(x=>x.id===customerId);
                summary = `${customer?customer.name:'Select a customer'} | Records: ${cols.length} | Amount: ${formatCurrency(totals.amount)} | Penalty: ${formatCurrency(totals.penalty)} | Total: ${formatCurrency(totals.amount + totals.penalty)}`;
            }

            renderReport(header, rows);
            document.getElementById('summary').textContent = summary;
        }

        function renderReport(header, rows){
            const thead = document.getElementById('reportHead');
            const tbody = document.getElementById('reportBody');
            thead.innerHTML = `<tr>${header.map(h=>`<th>${h}</th>`).join('')}</tr>`;
            if (!rows.length){
                tbody.innerHTML = '<tr><td colspan="'+header.length+'" style="text-align:center; padding:1rem; color:hsl(var(--muted-foreground));">No data for selected filters.</td></tr>';
                return;
            }
            tbody.innerHTML = rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('');
        }

        function exportReportCSV(){
            const header = [...document.querySelectorAll('#reportHead th')].map(th=>th.innerText);
            const rows = [...document.querySelectorAll('#reportBody tr')].map(tr=>[...tr.children].map(td=>td.innerText));
            if (!rows.length){ showToast('Nothing to export', 'warning'); return; }
            const csv = [header, ...rows].map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
            const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'report.csv'; a.click();
            URL.revokeObjectURL(url);
            showToast('CSV exported', 'success');
        }
    </script>
</body>
</html>






